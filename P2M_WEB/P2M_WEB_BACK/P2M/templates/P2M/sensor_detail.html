{% extends "P2M/Base.html" %}{% block content %}

<table class="table">
  <thead>
    <tr>
      <th scope="col">ID</th>
      <th scope="col">Name</th>
      <th scope="col">Latitude</th>
      <th scope="col">Longitude</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>{{ sensor.id }}</td>
      <td>{{ sensor.name }}</td>
      <td>{{ sensor.latitude }}</td>
      <td>{{ sensor.longitude }}</td>
    </tr>
  </tbody>
</table>
<div
  class="chart-container"
  style="
    display: flex;
    flex-wrap: wrap;
    flex-direction: row;
    justify-content: space-around;
  "
>
  <div style="width: 40vw">
    <canvas class="border border-4 border-black mb-2" id="phChart"></canvas>
  </div>
  <div style="width: 40vw">
    <canvas
      class="border border-4 border-black mb-2"
      id="temperatureChart"
    ></canvas>
  </div>
  <div style="width: 40vw">
    <canvas
      class="border border-4 border-black mb-2"
      id="rainfallChart"
    ></canvas>
  </div>
  <div style="width: 40vw">
    <canvas
      class="border border-4 border-black mb-2"
      id="humidityChart"
    ></canvas>
  </div>
  <div style="width: 40vw">
    <canvas class="border border-4 border-black" id="npkChart"></canvas>
  </div>
</div>

{% endblock content %} {% block JS %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  var sensorsData = JSON.parse("{{ mesure_json | escapejs }}");
  // Step 1: Extract data for the last year from the sensorsData
  var lastYearData = sensorsData.filter(function (measure) {
    var measureDate = new Date(measure.date);
    var currentDate = new Date();
    return (
      measureDate >
      new Date(currentDate.getFullYear() - 1, currentDate.getMonth() + 1)
    );
  });

  // Step 2: Group the data by month
  var monthlyData = {};
  lastYearData.forEach(function (measure) {
    var measureDate = new Date(measure.date);
    var monthKey = measureDate.getMonth(); // Month index starts from 0
    if (!monthlyData[monthKey]) {
      monthlyData[monthKey] = [];
    }
    monthlyData[monthKey].push(measure);
  });
  console.log(monthlyData);

  // Step 3: Prepare data for Chart.js
  var labels = [];
  var phData = [];
  var temperatureData = [];
  var humidityData = [];
  var nitrogenData = [];
  var phosphorusData = [];
  var potassiumData = [];
  var rainfallData = [];

  var currentMonth = new Date().getMonth(); // Get the current month index
  var currentYear = new Date().getFullYear(); // Get the current year

  // Adjust current month and year
  currentMonth++; // Increment current month
  if (currentMonth === 12) {
    // Set to January and increment the year
    currentMonth = 0;
    currentYear++;
  }

  Object.keys(monthlyData).forEach(function (monthKey) {
    var monthMeasures = monthlyData[monthKey];
    var avgPH = 0;
    var avgTemperature = 0;
    var avgHumidity = 0;
    var avgNitrogen = 0;
    var avgPhosphorus = 0;
    var avgPotassium = 0;
    var avgRainfall = 0;

    monthMeasures.forEach(function (measure) {
      avgPH += measure.ph;
      avgTemperature += measure.temperature;
      avgHumidity += measure.humidity;
      avgNitrogen += measure.nitrogen;
      avgPhosphorus += measure.phosphorus;
      avgPotassium += measure.potassium;
      avgRainfall += measure.rainfall;
    });

    avgPH /= monthMeasures.length;
    avgTemperature /= monthMeasures.length;
    avgHumidity /= monthMeasures.length;
    avgNitrogen /= monthMeasures.length;
    avgPhosphorus /= monthMeasures.length;
    avgPotassium /= monthMeasures.length;
    avgRainfall /= monthMeasures.length;

    var monthLabel = new Date(currentYear, currentMonth, 1).toLocaleString(
      "default",
      { month: "long" }
    );
    labels.push(monthLabel);
    phData.push(avgPH);
    temperatureData.push(avgTemperature);
    humidityData.push(avgHumidity);
    nitrogenData.push(avgNitrogen);
    phosphorusData.push(avgPhosphorus);
    potassiumData.push(avgPotassium);
    rainfallData.push(avgRainfall);

    currentMonth++;
    if (currentMonth === 12) {
      // Set to January and increment the year
      currentMonth = 0;
      currentYear++;
    }
  });

  // Now you can use the labels and data arrays for Chart.js

  // Step 4: Create line chart using Chart.js
  var ctxph = document.getElementById("phChart").getContext("2d");
  var myChart = new Chart(ctxph, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: "pH",
          data: phData,
          borderColor: "rgba(255, 99, 132, 1)",
          borderWidth: 1,
          fill: false,
        },
      ],
    },
    options: {
      scales: {
        yAxes: [
          {
            ticks: {
              beginAtZero: true,
            },
          },
        ],
      },
    },
  });
  var ctxtemp = document.getElementById("temperatureChart").getContext("2d");
  var myChart = new Chart(ctxtemp, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Temperature",
          data: temperatureData,
          borderColor: "rgba(54, 162, 235, 1)",
          borderWidth: 1,
          fill: false,
        },
      ],
    },
    options: {
      scales: {
        yAxes: [
          {
            ticks: {
              beginAtZero: true,
            },
          },
        ],
      },
    },
  });
  var ctxrain = document.getElementById("rainfallChart").getContext("2d");
  var myChart = new Chart(ctxrain, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Rainfall",
          data: rainfallData,
          borderColor: "rgba(255, 99, 71, 1)",
          borderWidth: 1,
          fill: false,
        },
      ],
    },
    options: {
      scales: {
        yAxes: [
          {
            ticks: {
              beginAtZero: true,
            },
          },
        ],
      },
    },
  });
  var ctxhum = document.getElementById("humidityChart").getContext("2d");
  var myChart = new Chart(ctxhum, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Humidity",
          data: humidityData,
          borderColor: "rgba(255, 206, 86, 1)",
          borderWidth: 1,
          fill: false,
        },
      ],
    },
    options: {
      scales: {
        yAxes: [
          {
            ticks: {
              beginAtZero: true,
            },
          },
        ],
      },
    },
  });
  var ctxnpk = document.getElementById("npkChart").getContext("2d");
  var myChart = new Chart(ctxnpk, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Nitrogen",
          data: nitrogenData,
          borderColor: "rgba(75, 192, 192, 1)",
          borderWidth: 1,
          fill: false,
        },
        {
          label: "Phosphorus",
          data: phosphorusData,
          borderColor: "rgba(153, 102, 255, 1)",
          borderWidth: 1,
          fill: false,
        },
        {
          label: "Potassium",
          data: potassiumData,
          borderColor: "rgba(255, 159, 64, 1)",
          borderWidth: 1,
          fill: false,
        },
      ],
    },
    options: {
      scales: {
        yAxes: [
          {
            ticks: {
              beginAtZero: true,
            },
          },
        ],
      },
    },
  });
</script>

{% endblock JS %}
